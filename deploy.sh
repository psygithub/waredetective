#!/bin/bash

# =============================================================================
# DevOps è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬
#
# åŠŸèƒ½:
#   1. ä» Git æ‹‰å–æœ€æ–°ä»£ç ã€‚
#   2. åœæ­¢å¹¶åˆ é™¤æ—§çš„ Docker å®¹å™¨ã€‚
#   3. ä½¿ç”¨æœ€æ–°ä»£ç æ„å»ºä¸€ä¸ªæ–°çš„ Docker é•œåƒã€‚
#   4. å¯åŠ¨ä¸€ä¸ªæ–°çš„å®¹å™¨æ¥è¿è¡Œåº”ç”¨ã€‚
#   5. æ¸…ç†æ„å»ºè¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ— ç”¨é•œåƒã€‚
#
# ä½¿ç”¨æ–¹æ³•:
#   ./deploy.sh
#
# =============================================================================

# --- åœ¨è¿™é‡Œé…ç½®æ‚¨çš„å˜é‡ ---
CONTAINER_NAME="warehouse-container"
IMAGE_NAME="warehouse"
# -------------------------

# set -e çš„ä½œç”¨æ˜¯ï¼šå¦‚æœä»»ä½•å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼ˆè¿”å›éé›¶é€€å‡ºç ï¼‰ï¼Œ
# æ•´ä¸ªè„šæœ¬ä¼šç«‹å³åœæ­¢æ‰§è¡Œã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„å®‰å…¨æªæ–½ã€‚
set -e

# --- æ­¥éª¤ 1: ä» Git æ‹‰å–æœ€æ–°ä»£ç  ---
echo "--- [æ­¥éª¤ 1/5] æ­£åœ¨ä» Git æ‹‰å–æœ€æ–°ä»£ç ... ---"
git pull

# --- æ­¥éª¤ 2: æ¸…ç†æ—§çš„å®¹å™¨ ---
echo "--- [æ­¥éª¤ 2/5] æ­£åœ¨æ¸…ç†æ—§çš„å®¹å™¨ ($CONTAINER_NAME)... ---"
# æ£€æŸ¥å®¹å™¨æ˜¯å¦å­˜åœ¨
if [ -n "$(docker ps -a -q -f name=^/${CONTAINER_NAME}$)" ]; then
    echo "å‘ç°æ—§å®¹å™¨ï¼Œæ­£åœ¨åœæ­¢å¹¶åˆ é™¤..."
    # ä½¿ç”¨ || true æ¥é˜²æ­¢åœ¨å®¹å™¨ä¸å­˜åœ¨çš„æƒ…å†µä¸‹è„šæœ¬å›  set -e è€Œé€€å‡º
    docker stop "$CONTAINER_NAME" || true
    docker rm "$CONTAINER_NAME" || true
    echo "æ—§å®¹å™¨æ¸…ç†å®Œæ¯•ã€‚"
else
    echo "æœªå‘ç°æ—§å®¹å™¨ï¼Œæ— éœ€æ¸…ç†ã€‚"
fi

# --- æ­¥éª¤ 3: æ„å»º Docker é•œåƒ ---
echo "--- [æ­¥éª¤ 3/5] æ­£åœ¨æ„å»ºæ–°çš„ Docker é•œåƒ ($IMAGE_NAME)... ---"
docker build -t "$IMAGE_NAME" .

# --- æ­¥éª¤ 4: è¿è¡Œæ–°çš„ Docker å®¹å™¨ ---
echo "--- [æ­¥éª¤ 4/5] æ­£åœ¨å¯åŠ¨æ–°çš„å®¹å™¨ ($CONTAINER_NAME)... ---"
# è·å–è„šæœ¬æ‰€åœ¨çš„çœŸå®ç›®å½•ï¼Œç¡®ä¿æŒ‚è½½è·¯å¾„çš„æ­£ç¡®æ€§ï¼Œæ— è®ºä»å“ªé‡Œæ‰§è¡Œè„šæœ¬
SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &> /dev/null && pwd)

docker run -d \
  --network my-proxy-network \
  --restart unless-stopped \
  -p 3000:3000 \
  -v "$SCRIPT_DIR/data:/app/data" \
  -v "$SCRIPT_DIR/output:/app/output" \
  -v "$SCRIPT_DIR/config:/app/config" \
  --name "$CONTAINER_NAME" \
  "$IMAGE_NAME"

# --- æ­¥éª¤ 5: æ¸…ç†æ— ç”¨çš„é•œåƒ ---
# docker image prune ä¼šåˆ é™¤æ‰€æœ‰æ‚¬ç©ºï¼ˆdanglingï¼‰çš„é•œåƒï¼Œå³é‚£äº›æ²¡æœ‰æ ‡ç­¾ä¸”æœªè¢«ä»»ä½•å®¹å™¨ä½¿ç”¨çš„é•œåƒã€‚
# è¿™é€šå¸¸æ˜¯æ„å»ºæ–°ç‰ˆæœ¬é•œåƒåç•™ä¸‹çš„æ—§é•œåƒå±‚ã€‚
echo "--- [æ­¥éª¤ 5/5] æ­£åœ¨æ¸…ç†æ— ç”¨çš„ Docker é•œåƒ... ---"
docker image prune -f

echo ""
echo "==============================================="
echo "  ğŸš€ éƒ¨ç½²æˆåŠŸï¼"
echo "  å®¹å™¨ '$CONTAINER_NAME' å·²æˆåŠŸå¯åŠ¨ã€‚"
echo "==============================================="
