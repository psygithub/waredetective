FROM node:20-bullseye

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    chromium \
    sqlite3 \
    ca-certificates \
    fonts-freefont-ttf \
    fonts-wqy-microhei \
    # Chromium依赖
    libnss3 \
    libatk-bridge2.0-0 \
    libgtk-3-0 \
    libgbm-dev \
    libxss1 \
    libasound2 &&\
    rm -rf /var/lib/apt/lists/*

# 设置时区
RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo "Asia/Shanghai" > /etc/timezone

# 创建非root用户
RUN npm install &&\
    groupadd -r nodejs && useradd -r -g nodejs -m nextjs && \
    mkdir -p /app/data /app/output /app/public && \
    chown -R nextjs:nodejs /app

# 设置环境变量
ENV NODE_ENV=development
ENV PORT=3000
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
ENV PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium

USER nextjs

EXPOSE 3000

# 默认启动命令（可以在运行时覆盖）
CMD ["npm", "run", "server"]